# Pre-commit Hook Guide

## Overview

The pre-commit hook provides local validation before commits reach the remote repository. It performs essential checks to maintain code quality and prevent common issues.

## Features

- **Python Syntax Checking**: Validates Python syntax errors before commit
- **Large File Detection**: Prevents commits of files larger than 10MB
- **Secret Detection**: Basic pattern matching for potential secrets
- **Configurable**: Can be enabled/disabled via environment variable
- **Smart Python Detection**: Automatically detects available Python interpreter

## Installation

The pre-commit hook is automatically installed by the setup script:

```bash
# Install during setup
python devops/release_automation/setup.py

# Install without other setup components
python devops/release_automation/setup.py --no-alias

# Skip hook installation
python devops/release_automation/setup.py --no-hooks

# Check current setup
python devops/release_automation/setup.py --check
```

## Configuration

### Environment Variables

#### `DISABLE_PRECOMMIT_HOOK`
Controls whether the pre-commit hook runs:

```bash
# Disable the hook temporarily
export DISABLE_PRECOMMIT_HOOK=true
git commit -m "Your commit message"

# Disable permanently (add to shell profile)
echo 'export DISABLE_PRECOMMIT_HOOK=true' >> ~/.bashrc

# Re-enable the hook
unset DISABLE_PRECOMMIT_HOOK
# or
export DISABLE_PRECOMMIT_HOOK=false
```

**Values**: 
- `true` or `1` = Hook disabled
- `false`, `0`, or unset = Hook enabled (default)

## What the Hook Checks

### 1. Python Syntax Validation
- Compiles all staged Python files (`*.py`)
- Prevents commits with syntax errors
- Uses the available Python interpreter (`python3` or `python`)

### 2. Large File Detection
- Scans for files larger than 10MB
- Suggests using Git LFS for large files
- Prevents accidental commits of binary/large files

### 3. Secret Detection
- Basic pattern matching for common secret patterns
- Interactive prompt to confirm if patterns are detected
- Case-insensitive matching

## Usage Examples

### Normal Commit (Hook Enabled)
```bash
git add my_file.py
git commit -m "Add new feature"
# Output:
# üîç Running pre-commit checks...
# ‚úÖ Pre-commit checks passed
```

### Commit with Issues
```bash
git add broken_file.py
git commit -m "Add broken code"
# Output:
# üîç Running pre-commit checks...
# ‚ùå Python syntax error in broken_file.py
# (commit blocked)
```

### Temporarily Disable Hook
```bash
export DISABLE_PRECOMMIT_HOOK=true
git commit -m "Emergency fix"
# Output:
# üí° Pre-commit hook disabled via DISABLE_PRECOMMIT_HOOK environment variable
```



## Troubleshooting

### Hook Not Running
```bash
# Check if hook file exists and is executable
ls -la .git/hooks/pre-commit

# Reinstall the hook
python devops/release_automation/setup.py --force

# Check if disabled via environment
echo $DISABLE_PRECOMMIT_HOOK
```

### Python Interpreter Issues
The hook automatically detects the correct Python interpreter:
1. First tries `python3`
2. Falls back to `python`
3. Fails if neither is available

```bash
# Check available Python interpreters
which python3
which python

# Manual hook test
.git/hooks/pre-commit
```

### False Secret Detection
If the hook detects false positives for secrets:

1. **Temporary bypass**: Answer 'y' when prompted
2. **Permanent fix**: Update the pattern in `setup.py` and reinstall
3. **Disable check**: Temporarily disable the hook

### Performance Issues
For repositories with many Python files:

```bash
# Disable hook for large commits
DISABLE_PRECOMMIT_HOOK=true git commit -m "Large refactor"

# Or commit in smaller chunks
git add file1.py file2.py
git commit -m "Part 1: Add feature"
```

## Setup Script Integration

The pre-commit hook is generated by `setup.py`. To modify the hook:

1. **Edit the hook template** in `setup.py` (in the `setup_git_hooks()` function)
2. **Reinstall the hook**:
   ```bash
   python devops/release_automation/setup.py --force
   ```

### Auto-Detection Features

The setup script now includes intelligent auto-detection:

- **GitHub Repository**: Automatically detects owner/repo from Git remote
- **User Information**: Gets name and email from Git config
- **Python Interpreter**: Finds the best available Python command

## Best Practices

1. **Keep Hook Enabled**: Only disable when absolutely necessary
2. **Fix Issues Locally**: Address problems before committing
3. **Use Consistency Checker**: Run `python devops/consistency_checker/checker.py` before committing
4. **Regular Updates**: Reinstall hook when setup.py is updated
5. **Team Coordination**: Ensure all team members have the hook installed

## Integration with CI/CD

The pre-commit hook works with the broader CI/CD system:

- **Local Hook** ‚Üí **Branch CI** ‚Üí **PR Validation**
- Catches issues early in the development cycle
- Reduces CI/CD failures and iteration time
- Maintains consistent code quality standards

---

**Environment Variable**: `DISABLE_PRECOMMIT_HOOK=true` to disable  
**Installation**: Automatic via `setup.py`  
**Manual Test**: `.git/hooks/pre-commit`  
**Setup Check**: `python devops/release_automation/setup.py --check`
